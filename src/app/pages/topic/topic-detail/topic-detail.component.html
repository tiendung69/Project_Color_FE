<div
  style="
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-top: -30px;
  "
>
  <div
    style="
      display: flex;
      align-items: center;
      margin-top: 40px;
      width: 50%;
      margin-bottom: -30px;
    "
  >
    <div style="border-bottom: 1px solid #000; flex-grow: 1; width: 25%"></div>
    <div style="flex-grow: 1; text-align: center">
      <div
        style="
          padding: 0 10px;
          font-size: 25px;
          font-family: 'Museo Sans Rounded';
          font-weight: 900;
        "
        class="label-title;"
      >
        THÔNG TIN CHUNG
      </div>
    </div>
    <div style="border-bottom: 1px solid #000; flex-grow: 1; width: 25%"></div>
  </div>
</div>

<label class="label-title" style="margin-top: 25px">Đăng ký đề tài</label>

<div class="d-flex container-collapse" (click)="toggleCollapse2()">
  <div class="fa-1x mx-4 my-3">
    <i [className]="isCollapsed2 ? 'fa fa-plus' : 'fa fa-minus'"></i>
  </div>
  <span class="label-custom">Thông tin đề tài</span>
</div>
<form [ngbCollapse]="isCollapsed2" (ngSubmit)="onSubmit()" #form="ngForm">
  <div id="collapseExample">
    <div class="card">
      <div class="card-body">
        <div class="row">
          <div class="form-group col-md-3" style="margin-top: -7px">
            <label class="label-custom" for="Name">Loại đề tài*</label>
            <ejs-dropdownlist
              [readonly]="!enableForm || topicDetail.Status === 3"
              (change)="onChangeTopicType($event)"
              key="CategoryId"
              [dataSource]="listTopicCate"
              [fields]="dropdownRole"
              [value]="topicDetail.CategoryId"
              placeHolder="Chọn loại đề tài"
            ></ejs-dropdownlist>
            <p *ngIf="messageTopicType" style="color: red">
              Thông tin này là bắt buộc.
            </p>
          </div>
          <div class="form-group col-md-3" style="margin-top: -7px">
            <label class="label-custom" for="Name">Tên đề tài*</label>
            <app-textarea-input
              [readonly]="!enableForm || topicDetail.Status === 3"
              (newItemEvent)="onInputChange($event)"
              key="Name"
              [value]="topicDetail.Name"
              placeHolder="Nhập tên đề tài..."
            ></app-textarea-input>
            <p *ngIf="message" style="color: red">Thông tin này là bắt buộc.</p>
          </div>

          <div class="form-group col-md-3">
            <label class="label-custom" for="EstimatedBegin"
              >Thời gian dự kiến thực hiện</label
            >
            <ejs-datepicker
              [readonly]="!enableForm || topicDetail.Status === 3"
              id="EstimatedBegin"
              (valueChange)="
                onInputChange({ key: 'EstimatedBegin', value: $event })
              "
              format="dd/MM/yyyy"
              [value]="topicDetail.EstimatedBegin"
              placeholder="Thời gian dự kiến thực hiện"
            ></ejs-datepicker>
          </div>
          <div class="form-group col-md-3">
            <label class="label-custom" for="EstimatedEnd"
              >Thời gian dự kiến hoàn thành</label
            >
            <ejs-datepicker
              [readonly]="!enableForm || topicDetail.Status === 3"
              [value]="topicDetail.EstimatedEnd"
              (valueChange)="
                onInputChange({ key: 'EstimatedEnd', value: $event })
              "
              format="dd/MM/yyyy"
              placeholder="Thời gian dự kiến hoàn thành "
            ></ejs-datepicker>
          </div>
          <div class="form-group col-md-3">
            <label class="label-custom" for="EstimatedEnd"
              >Thời gian dự kiến phát sóng</label
            >
            <ejs-datepicker
              [readonly]="topicDetail.Status === 3 || !enableForm"
              [value]="topicDetail.EstimatedBroadcasting"
              (valueChange)="
                onInputChange({ key: 'EstimatedBroadcasting', value: $event })
              "
              format="dd/MM/yyyy"
              placeholder="Thời gian dự kiến phát sóng"
            ></ejs-datepicker>
          </div>
          <div class="form-group col-md-4">
            <label class="label-custom" for="Description">Mô tả đề tài</label>
            <app-textarea-input
              [multiline]="true"
              [readonly]="!enableForm || topicDetail.Status === 3"
              (newItemEvent)="onInputChange($event)"
              key="Description"
              [value]="topicDetail.Description"
              placeHolder="Nhập mô tả đề tài..."
            ></app-textarea-input>
          </div>
          <div class="form-group col-md-5">
            <label class="label-custom" for="Scenario">Kịch bản sơ bộ</label>
            <app-textarea-input
              [multiline]="true"
              [readonly]="!enableForm || topicDetail.Status === 3"
              (newItemEvent)="onInputChange($event)"
              key="Scenario"
              [value]="topicDetail.Scenario"
              placeHolder="Nhập kịch bản sơ bộ..."
            ></app-textarea-input>
          </div>
        </div>
        <div
          class="row justify-content-center mt-5 mb-4"
          *ngIf="topicDetail.Status !== 3 && enableForm"
        >
          <button
            class="btn btn-secondary btn-custom mr-4 btn-custom-large py-2"
            type="button"
            (click)="onCancelClick()"
          >
            Hủy
          </button>
          <button
            class="btn btn-primary btn-custom btn-custom-large py-2"
            type="submit"
            content="Save"
          >
            Lưu
          </button>
        </div>
      </div>
    </div>
  </div>
</form>

<div class="hr"></div>
<div [ngbCollapse]="idTopic ? false : true">
  <div class="d-flex container-collapse" (click)="toggleCollapse()">
    <div class="fa-1x mx-4 my-3">
      <i [className]="isCollapsed ? 'fa fa-plus' : 'fa fa-minus'"></i>
    </div>
    <span class="label-custom">Các video, hình ảnh đính kèm</span>
  </div>
  <ejs-grid
    #gridDocument
    [dataSource]="listDocument"
    [ngbCollapse]="isCollapsed"
    [toolbar]="toolbarOptions"
    [editSettings]="editSettings"
    [allowPaging]="true"
    gridLines="Both"
    [allowSorting]="true"
    [allowTextWrap]="true"
    [pageSettings]="{ pageSize: 5 }"
    (actionBegin)="actionBeginDocuments($event)"
    (actionComplete)="actionCompleteDoc($event)"
    (rowDataBound)="rowDataBound($event)"
    (commandClick)="commandClick($event)"
  >
    <e-columns>
      <e-column field="Description" headerText="Mô tả" width="500px">
        <ng-template #editTemplate let-data>
          <div class="multiline">
            <app-textarea-input
              [multiline]="true"
              (newItemEvent)="onInputChangeDoc($event)"
              key="Description"
              [value]="data.Description"
              placeHolder="Mô Tả"
            ></app-textarea-input>
            <!-- <ejs-textbox
                        [multiline]="true"
                        [value]="data.Description"
                        (created)="createHandler($event)"
                        (input)="inputHandler($event)"
                        floatLabelType="Auto"
                        placeholder="Mô Tả"
                        (valueChange)="
                          onInputChangeDoc({ key: 'Description', value: $event })
                        "
                      ></ejs-textbox> -->
          </div>
        </ng-template>
      </e-column>
      <e-column field="FileUrl" headerText="Tệp đính kèm" width="350px">
        <ng-template let-data #template
          ><a
            style="cursor: pointer"
            *ngIf="data.FileUrl"
            data-toggle="tooltip"
            data-placement="top"
            title="{{ data.Description }}"
            (click)="onFileUrlClick(data.FileUrl)"
          >
            {{ getFileName(data.FileUrl) }}
          </a></ng-template
        >
        <ng-template #editTemplate let-data>
          <div
            class="input-group file-upload"
            *ngIf="!data?.FileUrl; else other_content"
          >
            <input
              type="file"
              (change)="fileChange(input)"
              #input
              class="file-upload-btn"
            />
            <input
              type="text"
              class="form-control"
              placeholder="Choose a file..."
              value="{{ file }}"
            />
            <i
              class="fa fa-times delete-file"
              (click)="removeFile()"
              *ngIf="file"
            ></i>
            <span class="input-group-append">
              <button class="btn btn-primary" type="button">
                <i class="fa fa-upload"></i>
              </button>
            </span>
          </div>
          <ng-template #other_content
            ><a
              style="cursor: pointer"
              class="form-control"
              *ngIf="data.FileUrl"
              data-toggle="tooltip"
              data-placement="top"
              title="{{ data.Description }}"
              (click)="onFileUrlClick(data.FileUrl)"
            >
              {{ getFileName(data.FileUrl) }}
            </a></ng-template
          >
          <p *ngIf="messageFile" style="color: red; margin-top: 7px">
            Thông tin này là bắt buộc.
          </p>
        </ng-template>
      </e-column>
      <e-column
        headerText=""
        textAlign="Center"
        width="90px"
        [commands]="commands"
      >
      </e-column>
    </e-columns>
  </ejs-grid>
</div>
<div #container class="root-container"></div>
<ejs-dialog #ejDialog [visible]="false" [target]="targetElement" width="300px">
</ejs-dialog>
<div #container class="root-container"></div>
<ejs-dialog
  #ejDialogMember
  [visible]="false"
  [target]="targetElement"
  width="300px"
>
</ejs-dialog>
<div class="hr"></div>
<div [ngbCollapse]="idTopic ? false : true">
  <div class="d-flex container-collapse" (click)="toggleCollapse1()">
    <div class="fa-1x mx-4 my-3">
      <i [className]="isCollapsed1 ? 'fa fa-plus' : 'fa fa-minus'"></i>
    </div>
    <span class="label-custom">Nhân lực dự kiến cho tổ đội sản xuất</span>
  </div>
  <ejs-grid
    #gridMember
    [ngbCollapse]="isCollapsed1"
    [dataSource]="listMembers"
    [toolbar]="toolbarOptions"
    [editSettings]="editSettings"
    [allowPaging]="true"
    [allowSorting]="true"
    [allowTextWrap]="true"
    [pageSettings]="{ pageSize: 5 }"
    (actionBegin)="actionBeginMember($event)"
    (actionComplete)="actionCompleteMem($event)"
  >
    <e-columns>
      <!-- Other columns -->
      <e-column field="MemberId" headerText="Nhân viên" width="150">
        <ng-template let-data #template>{{
          handleRenderMember(data.MemberId)
        }}</ng-template>
        <ng-template #editTemplate let-data>
          <ejs-dropdownlist
            *ngIf="listUser"
            [ngModelOptions]="{ standalone: true }"
            [dataSource]="listUser"
            placeholder="Thành viên"
            [(ngModel)]="data.MemberId"
            [fields]="dropdownUser"
            [itemTemplate]="itemTemplate"
            [valueTemplate]="valueTemplate"
            (valueChange)="onInputChangeMem({ key: 'MemberId', value: $event })"
          >
            <ng-template #itemTemplate let-data>
              <span>{{ data.FirstName }} {{ data.LastName }}</span>
            </ng-template>

            <ng-template #valueTemplate let-data>
              <span>{{ data.FirstName }} {{ data.LastName }}</span>
            </ng-template>
          </ejs-dropdownlist>
          <p *ngIf="messageMember" style="color: red">
            Thông tin này là bắt buộc.
          </p>
        </ng-template>
      </e-column>
      <e-column field="Role" headerText="Vai trò" width="150">
        <ng-template #editTemplate let-data>
          <div class="multiline">
            <app-textarea-input
              [multiline]="true"
              (newItemEvent)="onInputChangeMem($event)"
              key="Role"
              [value]="data.Role"
              placeHolder="Nhập vai trò..."
            ></app-textarea-input>
          </div>
        </ng-template>
      </e-column>
      <e-column field="Description" headerText="Mô tả" width="150">
        <ng-template #editTemplate let-data>
          <div class="multiline">
            <app-textarea-input
              [multiline]="true"
              (newItemEvent)="onInputChangeMem($event)"
              key="Description"
              [value]="data.Description"
              placeHolder="Mô Tả"
            ></app-textarea-input>
          </div>
        </ng-template>
      </e-column>
    </e-columns>
  </ejs-grid>
</div>

<div
  *ngIf="idTopic"
  style="
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-top: -30px;
  "
>
  <div
    *ngIf="topicDetail.Status !== 0 || enableApprove"
    style="
      display: flex;
      align-items: center;
      margin-top: 65px;
      width: 50%;
      margin-bottom: -30px;
    "
  >
    <div style="border-bottom: 1px solid #000; flex-grow: 1; width: 25%"></div>
    <div style="flex-grow: 1; text-align: center">
      <div
        style="
          padding: 0 10px;
          font-size: 25px;
          font-family: 'Museo Sans Rounded';
          font-weight: 900;
        "
        class="label-title;"
      >
        LÃNH ĐẠO DUYỆT
      </div>
    </div>
    <div style="border-bottom: 1px solid #000; flex-grow: 1; width: 25%"></div>
  </div>
</div>

<div *ngIf="topicDetail.Status !== 0 || enableApprove">
  <label
    *ngIf="idTopic"
    class="label-title"
    style="width: 100%; margin-top: 25px; margin-bottom: 16px"
    >Phê duyệt đề tài</label
  >
  <div [ngbCollapse]="idTopic ? false : true">
    <div class="d-flex container-collapse" (click)="toggleCollapse3()">
      <div class="fa-1x mx-4 my-3">
        <i [className]="isCollapsed3 ? 'fa fa-plus' : 'fa fa-minus'"></i>
      </div>
      <span class="label-custom">Thông tin phê duyệt</span>
    </div>
    <div [ngbCollapse]="isCollapsed3" id="collapseExample">
      <div class="card">
        <div class="card-body">
          <form>
            <div class="row" *ngIf="aprovedTimes > 0">
              <div class="form-group col-3">
                <label class="label-custom" for="Name">Người duyệt: </label>
                <span>
                  {{ handleRenderMember(approvedDetail.ProcessedBy) }}</span
                >
              </div>
              <div class="form-group col-3">
                <label class="label-custom" for="Name">Ngày duyệt: </label>
                <span *ngIf="approvedDetail.ProcessedAt">
                  {{ handleRenderDate(approvedDetail.ProcessedAt) }}</span
                >
              </div>
              <div class="form-group col-3">
                <label class="label-custom" for="Name">Kết quả duyệt: </label>
                <span> {{ handleRenderResult(approvedDetail.Result) }}</span>
              </div>
              <div class="form-group col-3">
                <label class="label-custom" for="Name">Lần duyệt: </label>
                <span> {{ aprovedTimes }}</span>
              </div>
            </div>
            <div class="row">
              <div class="form-group col">
                <label class="label-custom" for="Name">Nhận xét</label>
                <app-textarea-input
                  [multiline]="true"
                  [readonly]="!enableApprove"
                  (newItemEvent)="onInputComment($event)"
                  key="Comment"
                  [value]="approvedDetail.Comment"
                  [placeHolder]="!enableApprove ? '' : 'Nhập nhận xét...'"
                ></app-textarea-input>
              </div>
            </div>
            <div
              class="row justify-content-center mt-5 mb-4"
              *ngIf="enableApprove"
            >
              <button
                *ngIf="approvedDetail.Result != status.APPROVE"
                class="btn btn-secondary btn-custom mr-4 btn-custom-large py-2"
                type="button"
                (click)="onSubmitApprove(status.REJECT)"
              >
                Từ chối
              </button>
              <button
                class="btn btn-primary btn-custom btn-custom-large py-2"
                type="submit"
                content="Save"
                (click)="onSubmitApprove(status.APPROVE)"
              >
                Phê duyệt
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="topicDetail.Status !== 0 || enableApprove">
  <div [ngbCollapse]="idTopic ? false : true" style="margin-top: 10px">
    <div class="d-flex container-collapse" (click)="toggleCollapse4()">
      <div class="fa-1x mx-4 my-3">
        <i [className]="isCollapsed4 ? 'fa fa-plus' : 'fa fa-minus'"></i>
      </div>
      <span class="label-custom">Lịch sử phê duyệt</span>
    </div>
  </div>
  <div *ngIf="listApproved.length === 0" class="no-approval-history">
    <div [ngbCollapse]="isCollapsed4">
      <div
        class="card"
        style="margin-top: 10px; border: 0px"
        style="height: 57px"
      >
        <div class="card-body">
          <p style="color: red">Chưa có lượt duyệt nào.</p>
        </div>
      </div>
    </div>
  </div>
  <div *ngIf="listApproved && listApproved.length">
    <div *ngFor="let item of listApproved; let i = index">
      <div [ngbCollapse]="isCollapsed4">
        <div class="card" style="margin-top: -5px">
          <div class="card-body">
            <form>
              <div class="row" *ngIf="aprovedTimes > 0">
                <div class="form-group col-3">
                  <label class="label-custom" for="Name">Người duyệt: </label>
                  <span> {{ handleRenderMember(item.ProcessedBy) }}</span>
                </div>
                <div class="form-group col-3">
                  <label class="label-custom" for="Name">Ngày duyệt: </label>
                  <span *ngIf="item.ProcessedAt">
                    {{ handleRenderDate(item.ProcessedAt) }}</span
                  >
                </div>
                <div class="form-group col-3">
                  <label class="label-custom" for="Name">Kết quả duyệt: </label>
                  <span> {{ handleRenderResult(item.Result) }}</span>
                </div>
                <div class="form-group col-3">
                  <label class="label-custom" for="Name"
                    >Lần duyệt:&nbsp;</label
                  >
                  <span>{{ aprovedTimes - i }}</span>
                </div>
              </div>
              <div class="row">
                <div class="form-group col">
                  <label
                    class="label-custom"
                    for="Name"
                    (click)="toggleCommentVisibility(i)"
                  >
                    <div style="display: flex; align-items: center">
                      <div
                        style="
                          margin-right: 10px;
                          font-size: 23px;
                          margin-top: -6px;
                        "
                      >
                        {{
                          i === selectedCommentIndex && isCommentVisible
                            ? "-"
                            : "+"
                        }}
                      </div>
                      Nhận xét
                    </div>
                  </label>
                </div>
              </div>

              <div
                class="row"
                *ngIf="isCommentVisible && i === selectedCommentIndex"
              >
                <div class="form-group col">
                  <app-textarea-input
                    [multiline]="true"
                    [readonly]="true"
                    (newItemEvent)="onInputComment($event)"
                    key="Comment"
                    [value]="item !== undefined ? item.Comment : ''"
                  ></app-textarea-input>
                </div>
              </div>
            </form>
          </div>
        </div>
        <div #container class="root-container"></div>
      </div>
    </div>
  </div>
</div>

<app-video-compressor
  *ngIf="open"
  (addSuccess)="onSuccessUploadPart($event)"
  (onHideModal)="onHideModal()"
  [idUploadPart]="uploadPartId"
></app-video-compressor>
